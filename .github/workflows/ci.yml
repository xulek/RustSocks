name: CI

on:
  push:
    branches:
      - master
  pull_request:

env:
  CARGO_TERM_COLOR: always

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate workflow syntax
        run: |
          python3 - <<'PY'
          import yaml
          from pathlib import Path

          workflows_dir = Path(".github/workflows")
          for workflow in workflows_dir.glob("*.yml"):
              with workflow.open() as fh:
                  yaml.safe_load(fh)
              print(f"Validated {workflow}")
          PY

      - name: Install system dependencies
        run: sudo apt-get update && sudo apt-get install -y libpam0g-dev

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2

      - name: Build with database feature
        run: cargo build --locked --all-targets --features database

  test:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: sudo apt-get update && sudo apt-get install -y libpam0g-dev

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2

      - name: Run tests (skip performance benchmarks)
        id: cargo-tests
        continue-on-error: true
        run: |
          set -euo pipefail
          cargo test --locked --all-targets --features database -- --skip performance 2>&1 | tee cargo-test-output.log
          exit "${PIPESTATUS[0]}"

      - name: Summarize test results
        if: always()
        run: |
          python3 - <<'PY'
          import re
          from pathlib import Path

          log_path = Path("cargo-test-output.log")
          if not log_path.exists():
              print("No cargo-test-output.log found.")
              raise SystemExit(0)

          pattern = re.compile(r'(\d+)\s+(passed|failed|ignored|measured|filtered out)')
          labels = {
              "passed": "passed",
              "failed": "failed",
              "ignored": "ignored",
              "measured": "measured",
              "filtered out": "filtered_out",
          }
          totals = {v: 0 for v in labels.values()}
          for line in log_path.read_text().splitlines():
              if "test result:" not in line:
                  continue
              for count, label in pattern.findall(line):
                  key = labels[label]
                  totals[key] += int(count)

          total_executed = totals["passed"] + totals["failed"]

          print("Test summary:")
          print(f"- Executed: {total_executed}")
          print(f"- Passed:   {totals['passed']}")
          print(f"- Failed:   {totals['failed']}")
          print(f"- Ignored:  {totals['ignored']}")
          print(f"- Measured: {totals['measured']}")
          print(f"- Skipped (filtered out): {totals['filtered_out']}")
          PY

      - name: Fail if tests failed
        if: steps.cargo-tests.outcome == 'failure'
        run: exit 1
