# SSSD Configuration for Active Directory Integration
# File location: /etc/sssd/sssd.conf
#
# This configuration enables RustSocks to authenticate users against
# Microsoft Active Directory and retrieve group memberships for ACL evaluation.
#
# INSTRUCTIONS:
# 1. Copy this file to /etc/sssd/sssd.conf
# 2. Update the domain name (ad.company.com → your AD domain)
# 3. Update DC hostnames (dc01.ad.company.com → your DCs)
# 4. Set strict permissions: chmod 600 /etc/sssd/sssd.conf
# 5. Restart SSSD: systemctl restart sssd
#
# REQUIREMENTS:
# - Linux server joined to AD domain (use 'realm join')
# - DNS pointing to AD DNS servers
# - Time synchronized with AD (NTP/chrony)
# - Ports 88, 389, 636 open to AD DCs

[sssd]
# Services to enable
services = nss, pam
config_file_version = 2

# AD domain(s) to manage
domains = ad.company.com

[nss]
# NSS service configuration
filter_groups = root
filter_users = root
reconnection_retries = 3

[pam]
# PAM service configuration
reconnection_retries = 3
offline_credentials_expiration = 2
offline_failed_login_attempts = 3
offline_failed_login_delay = 5

[domain/ad.company.com]
#=============================================================================
# Provider Configuration
#=============================================================================

# Use Active Directory provider (optimized for AD)
id_provider = ad
auth_provider = ad
access_provider = ad
chpass_provider = ad

#=============================================================================
# Active Directory Server Settings
#=============================================================================

# Primary AD domain controllers (comma-separated)
# Replace with your actual DC hostnames or IPs
ad_server = dc01.ad.company.com, dc02.ad.company.com

# Backup AD domain controllers
ad_backup_server = dc03.ad.company.com

# AD domain name (FQDN, lowercase)
ad_domain = ad.company.com

# Hostname of this Linux server (FQDN)
# Should match the hostname in AD computer account
ad_hostname = rustsocks.ad.company.com

#=============================================================================
# Kerberos Settings
#=============================================================================

# Kerberos realm (UPPERCASE, typically same as AD domain)
krb5_realm = AD.COMPANY.COM

# Kerberos KDCs (usually same as AD DCs)
krb5_server = dc01.ad.company.com, dc02.ad.company.com
krb5_backup_server = dc03.ad.company.com

# Store Kerberos tickets for offline authentication
krb5_store_password_if_offline = True

# Kerberos ticket lifetime (match AD policy)
krb5_lifetime = 24h
krb5_renewable_lifetime = 7d

#=============================================================================
# LDAP Settings
#=============================================================================

# LDAP URIs (use ldaps:// for TLS, ldap:// for unencrypted)
# RECOMMENDED: Use ldaps:// in production
ldap_uri = ldap://dc01.ad.company.com, ldap://dc02.ad.company.com
ldap_backup_uri = ldap://dc03.ad.company.com

# For encrypted LDAP (RECOMMENDED for production):
# ldap_uri = ldaps://dc01.ad.company.com:636, ldaps://dc02.ad.company.com:636
# ldap_backup_uri = ldaps://dc03.ad.company.com:636
# ldap_tls_reqcert = demand
# ldap_tls_cacert = /etc/pki/tls/certs/ca-bundle.crt

# Use AD schema
ldap_schema = ad

# Automatically map AD SIDs to Unix UIDs/GIDs
# RECOMMENDED: Enables automatic UID/GID assignment
ldap_id_mapping = True

# UID/GID mapping range (prevents conflicts with local users)
ldap_idmap_range_min = 200000
ldap_idmap_range_max = 2000200000
ldap_idmap_range_size = 200000

# Disable LDAP referrals (can cause issues with some AD setups)
ldap_referrals = False

# Attribute mappings (match AD schema)
ldap_user_principal = userPrincipalName
ldap_user_fullname = displayName
ldap_user_name = sAMAccountName
ldap_group_name = sAMAccountName

#=============================================================================
# Access Control (Optional)
#=============================================================================

# Uncomment to restrict access to specific AD group
# Only users in this group (or nested groups) can authenticate
# access_provider = ad
# ad_access_filter = (memberOf:1.2.840.113556.1.4.1941:=CN=SOCKS-Users,OU=Groups,DC=company,DC=com)
#
# Note: 1.2.840.113556.1.4.1941 is LDAP_MATCHING_RULE_IN_CHAIN (supports nested groups)

#=============================================================================
# Caching & Performance
#=============================================================================

# Cache credentials for offline authentication
cache_credentials = True

# Cache timeout (seconds)
entry_cache_timeout = 300
entry_cache_user_timeout = 300
entry_cache_group_timeout = 300

# Disable full user/group enumeration (improves performance)
# With this disabled, 'getent passwd' won't list all AD users
enumerate = False

# Refresh timeout for enumeration (if enabled)
ldap_enumeration_refresh_timeout = 300

# How often to check if we're still online (seconds)
offline_timeout = 60

#=============================================================================
# Home Directory & Shell Settings
#=============================================================================

# Home directory pattern (%u = username)
override_homedir = /home/%u
fallback_homedir = /home/%u

# Default shell for AD users
default_shell = /bin/bash

#=============================================================================
# Name Format Settings
#=============================================================================

# Use fully qualified names (username@domain.com)
# Set to False to allow short names (username)
use_fully_qualified_names = True

# If using short names (use_fully_qualified_names = False):
# - Pros: Users can login with just "alice" instead of "alice@ad.company.com"
# - Cons: Name conflicts if you have multiple domains
# - Recommended: Use True (FQDN) for multi-domain environments

#=============================================================================
# Debugging (Remove in Production)
#=============================================================================

# Debug level (0=disabled, 1-9=increasing verbosity)
# CAUTION: High debug levels generate massive logs
# Remove or set to 0 in production
# debug_level = 6

# Debug timestamps
# debug_timestamps = True

#=============================================================================
# Advanced Settings
#=============================================================================

# Automatically create home directories on first login
# NOTE: This setting is actually in PAM (pam_mkhomedir), not SSSD
# But keeping here for reference

# Follow LDAP referrals from AD (usually not needed)
# ldap_referrals = False

# How long to wait for LDAP responses (seconds)
ldap_network_timeout = 3

# Kerberos canonicalization (usually not needed)
# krb5_canonicalize = False

# DNS service discovery (if True, auto-discover DCs via SRV records)
# If False, uses ad_server/krb5_server explicitly
# dns_discovery_domain = ad.company.com

# Subdomains (automatically discover trusted AD domains)
# subdomains_provider = ad

# Full POSIX attributes in AD (if using UNIX attributes in AD)
# ldap_id_mapping = False  # Disable auto-mapping
# ldap_user_uid_number = uidNumber
# ldap_user_gid_number = gidNumber
# ldap_user_home_directory = unixHomeDirectory
# ldap_user_shell = loginShell

#=============================================================================
# NOTES
#=============================================================================
#
# 1. After editing this file, validate config:
#    sudo sssctl config-check
#
# 2. Check SSSD status:
#    sudo sssctl domain-status ad.company.com
#
# 3. Clear cache after config changes:
#    sudo sss_cache -E
#    sudo systemctl restart sssd
#
# 4. Test user lookup:
#    getent passwd alice@ad.company.com
#    id alice@ad.company.com
#
# 5. Test group lookup:
#    getent group developers@ad.company.com
#
# 6. View logs:
#    sudo journalctl -u sssd -f
#    sudo tail -f /var/log/sssd/sssd_ad.company.com.log
#
# 7. Enable debug logging (troubleshooting):
#    Add to [domain/ad.company.com]: debug_level = 9
#    Restart SSSD, check /var/log/sssd/sssd_ad.company.com.log
#
# 8. For multi-domain environments:
#    - Keep use_fully_qualified_names = True
#    - Enable subdomain discovery: subdomains_provider = ad
#    - Configure trust relationships in AD first
#
# 9. Performance tuning:
#    - Lower cache timeouts if AD changes frequently
#    - Raise cache timeouts if AD is stable (reduces AD queries)
#    - Disable enumerate (already disabled above)
#    - Use LDAPS to reduce authentication latency
#
# 10. Security hardening:
#     - Use ldaps:// instead of ldap://
#     - Set ldap_tls_reqcert = demand
#     - Enable ad_access_filter to restrict users
#     - Keep debug_level disabled in production
#     - Set strict file permissions: chmod 600 /etc/sssd/sssd.conf
#
#=============================================================================
