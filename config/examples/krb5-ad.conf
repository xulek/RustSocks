# Kerberos Configuration for Active Directory Integration
# File location: /etc/krb5.conf
#
# This configuration enables Kerberos authentication against Active Directory
# for RustSocks via PAM/SSSD.
#
# INSTRUCTIONS:
# 1. Copy this file to /etc/krb5.conf
# 2. Update the realm name (AD.COMPANY.COM → your AD domain in UPPERCASE)
# 3. Update DC hostnames (dc01.ad.company.com → your DCs)
# 4. Test with: kinit username@AD.COMPANY.COM
# 5. Verify ticket: klist
#
# REQUIREMENTS:
# - DNS resolution to AD domain
# - Time synchronized with AD (within 5 minutes)
# - Port 88 (TCP/UDP) open to AD DCs
# - Port 464 (TCP/UDP) open for password changes (optional)

[logging]
    # Kerberos logging configuration
    # default = FILE:/var/log/krb5libs.log
    # kdc = FILE:/var/log/krb5kdc.log
    # admin_server = FILE:/var/log/kadmind.log

[libdefaults]
    # Default Kerberos realm (MUST be UPPERCASE)
    # This is your AD domain name in uppercase
    default_realm = AD.COMPANY.COM

    # Use DNS to discover KDCs (Kerberos Domain Controllers)
    # Recommended for AD environments with proper DNS SRV records
    dns_lookup_realm = true
    dns_lookup_kdc = true

    # Ticket lifetime (how long tickets are valid)
    # Match your AD Group Policy setting
    # Format: Xh (hours), Xd (days), Xm (minutes)
    ticket_lifetime = 24h

    # Renewable ticket lifetime (how long tickets can be renewed)
    renew_lifetime = 7d

    # Allow ticket forwarding (needed for some delegation scenarios)
    forwardable = true

    # Proxiable tickets (allow services to act on behalf of users)
    proxiable = true

    # Disable reverse DNS lookup (can cause issues with some AD setups)
    # Set to true only if reverse DNS is properly configured
    rdns = false

    # Use DNS for canonicalizing hostnames
    # false = use as-is, true = canonicalize via DNS
    dns_canonicalize_hostname = false

    # Default ticket cache location
    # KEYRING = use kernel keyring (more secure, Linux-specific)
    # FILE = use file-based cache (/tmp/krb5cc_%{uid})
    # Recommended: KEYRING for production, FILE for troubleshooting
    default_ccache_name = KEYRING:persistent:%{uid}

    # For troubleshooting, use file-based cache:
    # default_ccache_name = FILE:/tmp/krb5cc_%{uid}

    # TGS enctypes (encryption types for ticket-granting service)
    # Use strong encryption types only
    # Remove weak types (des-cbc-crc, des-cbc-md5, arcfour-hmac) in production
    default_tgs_enctypes = aes256-cts-hmac-sha1-96 aes128-cts-hmac-sha1-96 rc4-hmac

    # TGT enctypes (encryption types for ticket-granting ticket)
    default_tkt_enctypes = aes256-cts-hmac-sha1-96 aes128-cts-hmac-sha1-96 rc4-hmac

    # Permitted enctypes (allowed encryption types)
    permitted_enctypes = aes256-cts-hmac-sha1-96 aes128-cts-hmac-sha1-96 rc4-hmac

    # Clock skew tolerance (seconds)
    # Kerberos requires clocks to be synchronized within this tolerance
    # Default: 300 seconds (5 minutes)
    # If you have time sync issues, temporarily increase to 600 (10 minutes)
    # CRITICAL: Fix time sync issues rather than increasing this value!
    clockskew = 300

    # UDP preferences (use UDP for initial requests, fall back to TCP)
    udp_preference_limit = 1

[realms]
    # Kerberos realm configuration for AD domain
    # Replace AD.COMPANY.COM with your domain (UPPERCASE)
    AD.COMPANY.COM = {
        # KDCs (Key Distribution Centers) - usually AD Domain Controllers
        # List primary and backup DCs
        kdc = dc01.ad.company.com
        kdc = dc02.ad.company.com
        kdc = dc03.ad.company.com

        # Admin server (for password changes and admin operations)
        # Usually the primary DC
        admin_server = dc01.ad.company.com

        # Default domain for this realm (lowercase)
        default_domain = ad.company.com

        # Master KDC (only relevant for MIT Kerberos, not AD)
        # master_kdc = dc01.ad.company.com

        # KDC ports (default: 88 for TCP/UDP)
        # kdc_ports = 88

        # Admin server port (default: 749)
        # admin_server_port = 749
    }

    # If you have multiple AD domains or trusts, add them here:
    # OTHERDOMAIN.COM = {
    #     kdc = otherdc01.otherdomain.com
    #     kdc = otherdc02.otherdomain.com
    #     admin_server = otherdc01.otherdomain.com
    #     default_domain = otherdomain.com
    # }

[domain_realm]
    # Map DNS domains to Kerberos realms
    # This tells Kerberos which realm to use for hosts in specific domains

    # Map .ad.company.com → AD.COMPANY.COM realm
    .ad.company.com = AD.COMPANY.COM
    ad.company.com = AD.COMPANY.COM

    # Map localhost to default realm (optional)
    # .localdomain = AD.COMPANY.COM
    # localdomain = AD.COMPANY.COM

    # For multi-domain environments, add mappings:
    # .otherdomain.com = OTHERDOMAIN.COM
    # otherdomain.com = OTHERDOMAIN.COM

[appdefaults]
    # Application-specific defaults

    # PAM configuration
    pam = {
        # Use Kerberos for password changes
        forwardable = true
        renewable = true

        # Validate tickets after obtaining them
        validate = true

        # Minimum UID for Kerberos authentication (ignore local system users)
        minimum_uid = 1000
    }

    # SSH configuration (if using Kerberos for SSH)
    # ssh = {
    #     forwardable = true
    # }

#=============================================================================
# TESTING COMMANDS
#=============================================================================
#
# 1. Request Kerberos ticket for AD user:
#    kinit username@AD.COMPANY.COM
#    (Enter AD password when prompted)
#
# 2. List current tickets:
#    klist
#    Output should show valid TGT (Ticket Granting Ticket)
#
# 3. Verify ticket encryption type:
#    klist -e
#    Should show aes256-cts-hmac-sha1-96 or aes128-cts-hmac-sha1-96
#
# 4. Request service ticket (e.g., for HTTP):
#    kvno HTTP/server.ad.company.com@AD.COMPANY.COM
#
# 5. Destroy tickets:
#    kdestroy
#
# 6. Test automatic KDC discovery:
#    nslookup -type=srv _kerberos._tcp.ad.company.com
#    Should return KDC servers
#
# 7. Enable Kerberos tracing (for troubleshooting):
#    export KRB5_TRACE=/dev/stderr
#    kinit username@AD.COMPANY.COM
#    (Will output detailed Kerberos protocol trace)
#
#=============================================================================
# TROUBLESHOOTING
#=============================================================================
#
# Error: "Clock skew too great"
# - Cause: Time difference between client and KDC >5 minutes
# - Fix: Synchronize time with AD DC
#   sudo chronyd -q
#   OR
#   sudo ntpdate dc01.ad.company.com
#
# Error: "Cannot find KDC for realm"
# - Cause: DNS not resolving KDC SRV records or explicit KDCs not reachable
# - Fix: Check DNS resolution
#   dig _kerberos._tcp.ad.company.com SRV
#   OR
#   nslookup -type=srv _kerberos._tcp.ad.company.com
#
# Error: "Pre-authentication failed"
# - Cause: Wrong password or user doesn't exist
# - Fix: Verify username/password, check user exists in AD
#
# Error: "Cannot resolve network address for KDC"
# - Cause: Cannot resolve KDC hostname via DNS
# - Fix: Add AD DNS servers to /etc/resolv.conf
#   nameserver <AD-DC-IP>
#
# Error: Tickets obtained but "checksum verification failed"
# - Cause: Encryption type mismatch
# - Fix: Ensure permitted_enctypes includes AD's supported types
#   (AD supports aes256-cts, aes128-cts, rc4-hmac)
#
# Slow authentication:
# - Cause: DNS lookups or reverse DNS
# - Fix: Set rdns = false (already done above)
#
# Permission denied on ticket cache:
# - Cause: Ticket cache directory permissions
# - Fix: For FILE cache, ensure /tmp is writable
#   For KEYRING cache, ensure kernel keyring support is loaded
#
#=============================================================================
# SECURITY NOTES
#=============================================================================
#
# 1. Encryption Types:
#    - aes256-cts-hmac-sha1-96: Strongest, recommended
#    - aes128-cts-hmac-sha1-96: Strong, widely compatible
#    - rc4-hmac (arcfour): Weaker, legacy support only
#    - des-cbc-*: Very weak, DO NOT USE (disabled by default in modern AD)
#
# 2. Ticket Lifetime:
#    - Shorter = more secure (reduces window for replay attacks)
#    - Longer = fewer re-authentications (better UX)
#    - Recommended: 8-24 hours for workstations, 1-4 hours for servers
#
# 3. Renewable Tickets:
#    - Allows tickets to be renewed without re-entering password
#    - Renew lifetime should be > ticket lifetime
#    - Recommended: 7 days for workstations
#
# 4. Forwardable Tickets:
#    - Allows delegation (user ticket forwarded to another service)
#    - Required for some enterprise SSO scenarios
#    - Security risk if compromised (can impersonate user)
#    - Only enable if needed
#
# 5. Ticket Cache:
#    - KEYRING: More secure (isolated per-user, in kernel memory)
#    - FILE: Less secure (written to disk, can be stolen)
#    - Recommended: KEYRING for production, FILE for debugging
#
# 6. Clock Skew:
#    - Keep as low as possible (default 300s = 5 minutes)
#    - Tight clock sync improves security (prevents replay attacks)
#    - Use NTP/chrony to sync with AD DC
#
# 7. DNS Security:
#    - DNS SRV record poisoning can redirect KDC queries
#    - Use DNSSEC if available
#    - Explicitly list KDCs in [realms] section for critical environments
#
#=============================================================================
# ADVANCED CONFIGURATION
#=============================================================================
#
# For cross-realm authentication (multiple AD forests):
# [capaths]
#     AD.COMPANY.COM = {
#         PARTNER.COM = .
#     }
#     PARTNER.COM = {
#         AD.COMPANY.COM = .
#     }
#
# For plugin modules (advanced):
# [plugins]
#     ccselect = {
#         disable = k5identity
#     }
#
# For PKINIT (certificate-based auth):
# [realms]
#     AD.COMPANY.COM = {
#         pkinit_anchors = FILE:/etc/pki/tls/certs/ca-bundle.crt
#         pkinit_kdc_hostname = dc01.ad.company.com
#     }
#
#=============================================================================
# REFERENCES
#=============================================================================
#
# - MIT Kerberos Documentation: https://web.mit.edu/kerberos/krb5-latest/doc/
# - Microsoft AD Kerberos: https://learn.microsoft.com/en-us/windows-server/security/kerberos/
# - Red Hat Kerberos Guide: https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html/configuring_authentication_and_authorization_in_rhel/configuring-a-kerberos-5-client_configuring-authentication-and-authorization-in-rhel
#
#=============================================================================
